# 定时任务增强设计概览

## 1. 背景

当前 Scripts 模块已支持脚本执行，但定时任务能力较弱：
- 脚本执行记录缺少详细日志
- 缺少任务执行历史查询
- 缺少任务失败重试机制
- 不支持任务依赖和编排

## 2. 设计目标

- **执行历史**：完整的执行记录和日志存储
- **失败重试**：支持自动重试策略
- **任务编排**：支持任务依赖和串行执行
- **分布式调度**：多 Agent 场景下的任务分发

## 3. 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          定时任务增强架构                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌────────────────────────────────────────────────────────────────────┐    │
│   │                        Scheduler (APIServer)                        │    │
│   │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │    │
│   │  │ Cron Trigger │  │ Task Queue   │  │ Retry Policy │              │    │
│   │  │ 定时触发     │  │ 任务队列     │  │ 重试策略     │              │    │
│   │  └──────────────┘  └──────────────┘  └──────────────┘              │    │
│   └────────────────────────────────────────────────────────────────────┘    │
│                                    │                                         │
│                                    ▼ 任务分发                                │
│   ┌────────────────────────────────────────────────────────────────────┐    │
│   │                          Task Executor                              │    │
│   │  ┌─────────────────────┐  ┌─────────────────────┐                  │    │
│   │  │ Execution History   │  │ Log Collector       │                  │    │
│   │  │ 执行历史存储        │  │ 日志收集            │                  │    │
│   │  └─────────────────────┘  └─────────────────────┘                  │    │
│   └────────────────────────────────────────────────────────────────────┘    │
│                                    │                                         │
│              ┌─────────────────────┼─────────────────────┐                  │
│              ▼                     ▼                     ▼                  │
│   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐          │
│   │  squ-agent (1)   │  │  squ-agent (2)   │  │  squ-agent (N)   │          │
│   │  ┌────────────┐  │  │  ┌────────────┐  │  │  ┌────────────┐  │          │
│   │  │  执行脚本  │  │  │  │  执行脚本  │  │  │  │  执行脚本  │  │          │
│   │  └────────────┘  │  │  └────────────┘  │  │  └────────────┘  │          │
│   └──────────────────┘  └──────────────────┘  └──────────────────┘          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 4. 核心功能

| 功能模块 | 说明 |
|---------|------|
| **任务定义** | 脚本、命令、超时时间、重试策略 |
| **调度配置** | Cron 表达式、单次执行、手动触发 |
| **执行历史** | 执行状态、开始/结束时间、耗时 |
| **执行日志** | 标准输出、标准错误、完整日志 |
| **失败重试** | 重试次数、重试间隔、最大重试 |
| **任务编排** | 任务依赖、串行执行、并行执行 |

## 5. 数据模型概要

```go
// 定时任务定义
type CronJob struct {
    ID          uint
    Name        string
    ScriptID    *uint       // 关联脚本
    Command     string      // 或直接命令
    ServerIDs   []uint      // 目标服务器
    CronExpr    string      // Cron 表达式
    Timeout     int         // 超时时间(秒)
    RetryCount  int         // 重试次数
    RetryDelay  int         // 重试间隔(秒)
    Enabled     bool
    CreatedAt   time.Time
    UpdatedAt   time.Time
}

// 任务执行记录
type JobExecution struct {
    ID          uint
    JobID       uint
    ServerID    uint
    Status      string      // pending, running, success, failed, timeout
    StartedAt   *time.Time
    FinishedAt  *time.Time
    Duration    int         // 执行耗时(毫秒)
    ExitCode    int
    Output      string      // 标准输出
    Error       string      // 标准错误
    RetryIndex  int         // 第几次重试
}

// 任务依赖（Phase 3）
type JobDependency struct {
    ID          uint
    JobID       uint        // 任务ID
    DependsOn   uint        // 依赖的任务ID
    Condition   string      // success, failure, always
}
```

## 6. 开发阶段规划

```
Phase 1: 执行历史增强
├── 执行记录模型
├── 执行日志存储
├── 历史查询 API
└── 前端执行历史页面

Phase 2: 失败重试
├── 重试策略配置
├── 重试调度逻辑
├── 重试次数限制
└── 重试通知

Phase 3: 任务编排
├── 任务依赖模型
├── DAG 调度引擎
├── 任务流执行
└── 任务流可视化

Phase 4: 分布式调度
├── 任务队列
├── 任务分发策略
├── 并发控制
└── 负载均衡
```

## 7. 与现有模块的关系

```
Scripts (脚本管理) ──► CronJob (定时任务)
                            │
                            ▼
Server (服务器) ◄───── 任务分发目标
                            │
                            ▼
Alert (告警) ◄───── 任务失败通知
                            │
                            ▼
Audit (审计) ◄───── 任务执行记录
```

## 8. 现有代码参考

```go
// internal/squ-agent/cron/cron.go - 现有 Cron 调度器
// internal/squ-agent/cron/scripts_result.go - 脚本执行结果记录
// internal/squ-agent/handler/script/ - 脚本执行 Handler
```

## 9. 待详细设计的问题

- [ ] 执行日志存储方案？（数据库 vs 文件系统）
- [ ] 日志量过大时如何处理？
- [ ] 任务编排的 DAG 如何避免循环依赖？
- [ ] 分布式场景下如何避免重复执行？
- [ ] 任务执行是否需要支持审批流程？
- [ ] 是否需要支持任务模板？
