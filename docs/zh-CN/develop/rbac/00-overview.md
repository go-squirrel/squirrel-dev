# RBAC 权限系统设计概览

## 1. 背景

Squirrel 运维平台当前缺少权限管理，所有登录用户拥有相同权限。需要实现基于角色的访问控制（RBAC），支持：

- 多角色管理（管理员、运维、开发、只读等）
- 细粒度权限控制（服务器、应用、脚本、文件、终端等）
- 可选的服务器级权限隔离

## 2. 架构设计

### 2.1 整体模型

```
┌─────────────────────────────────────────────────────────────┐
│                    RBAC 权限模型                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   User ──m:n──► Role ──m:n──► Permission                     │
│                                                              │
│   ┌─────────┐     ┌─────────┐     ┌─────────────────┐       │
│   │  User   │────►│  Role   │────►│   Permission    │       │
│   └─────────┘     └─────────┘     │ - resource      │       │
│       │               │           │ - action        │       │
│       │               │           └─────────────────┘       │
│       │               ▼                                       │
│       │         ┌───────────┐                                │
│       └────────►│ Server    │  服务器级权限范围（可选）        │
│                 │ Scope     │                                │
│                 └───────────┘                                │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 权限检查流程

```
┌──────────────────────────────────────────────────────────────────┐
│                        APIServer                                  │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│   Request ──► JWT认证 ──► RBAC中间件 ──► Handler ──► Agent        │
│                   │           │                                   │
│                   │           ├── 获取用户角色                     │
│                   │           ├── 检查角色权限                     │
│                   │           └── 检查服务器范围（可选）            │
│                   │                                               │
│                   ▼                                               │
│              user_id                                              │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

### 2.3 关键设计决策

| 决策点 | 选择 | 原因 |
|--------|------|------|
| 权限存储位置 | APIServer | Agent 不存储用户信息，统一由 APIServer 控制 |
| 权限检查时机 | APIServer 中间件 | 在请求到达 Agent 前拦截，减少 Agent 复杂度 |
| 权限粒度 | 资源+操作 | 如 `server:list`、`file:upload`，简洁且够用 |
| 通配符支持 | 支持 | `server:*` 表示所有服务器操作权限 |
| 服务器隔离 | 可选 | Phase 6 实现，满足更精细的权限需求 |

## 3. 资源定义

| 资源 | 说明 | 关联模块 |
|------|------|----------|
| `server` | 服务器管理 | Server、Terminal |
| `application` | 应用管理 | Application、Deployment |
| `monitor` | 监控数据 | Monitor |
| `script` | 脚本管理 | Script |
| `file` | 文件管理 | File |
| `terminal` | Web 终端 | Terminal |
| `user` | 用户管理 | User |
| `role` | 角色管理 | Role |

## 4. 预置角色

| 角色 | Code | 说明 | 典型权限 |
|------|------|------|----------|
| 超级管理员 | `super_admin` | 系统最高权限 | `*` |
| 运维管理员 | `admin` | 大部分管理权限 | 除用户管理外的所有权限 |
| 运维工程师 | `operator` | 日常运维操作 | 服务器、应用、脚本、文件、终端 |
| 开发人员 | `developer` | 开发调试 | 只读 + 终端 + 应用部署 |
| 只读用户 | `viewer` | 仅查看 | 列表和详情查看权限 |

## 5. 开发阶段规划

```
Phase 1: 数据模型
├── 01-model.md
├── 定义 User、Role、Permission 模型
├── 定义关联表 UserRole、RolePermission
└── 数据库迁移和初始化数据

Phase 2: 权限服务层
├── 02-service.md
├── RBACService 实现
├── 权限检查核心逻辑
└── 用户角色管理服务

Phase 3: 权限中间件
├── 03-middleware.md
├── RBACMiddleware 中间件
├── 路由配置
└── 现有路由改造

Phase 4: 管理接口
├── 04-api.md
├── 角色 CRUD 接口
├── 用户角色分配接口
└── 权限查询接口

Phase 5: 前端集成
├── 05-frontend.md
├── 权限 Store
├── 路由守卫
├── 按钮级权限控制
└── 用户角色管理页面

Phase 6: 服务器级权限（可选）
├── 06-server-scope.md
├── UserServerScope 模型
├── 服务器范围检查
└── 前端服务器选择器过滤
```

## 6. 文档索引

| 文档 | 阶段 | 主要内容 |
|------|------|----------|
| [01-model.md](./01-model.md) | Phase 1 | 数据模型定义 |
| [02-service.md](./02-service.md) | Phase 2 | 权限服务层 |
| [03-middleware.md](./03-middleware.md) | Phase 3 | 权限中间件 |
| [04-api.md](./04-api.md) | Phase 4 | 管理接口 |
| [05-frontend.md](./05-frontend.md) | Phase 5 | 前端集成 |
| [06-server-scope.md](./06-server-scope.md) | Phase 6 | 服务器级权限 |

## 7. 依赖关系

```
Phase 1 (model)
    │
    ▼
Phase 2 (service) ──────► Phase 4 (api)
    │                           │
    ▼                           ▼
Phase 3 (middleware) ◄──── Phase 5 (frontend)
    │
    ▼
Phase 6 (server-scope) [可选]
```

**建议开发顺序**：Phase 1 → 2 → 3 → 4 → 5，Phase 6 按需开发。

## 8. 注意事项

1. **向后兼容**：现有管理员用户自动获得 `super_admin` 角色
2. **默认行为**：未配置角色时，用户默认无任何权限（或根据需求配置默认角色）
3. **性能考虑**：权限检查结果可缓存，避免每次请求都查询数据库
4. **日志审计**：权限检查失败应记录日志，便于问题排查
